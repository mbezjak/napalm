#!/bin/bash
#
# Copyright (c) 2010 Miro Bezjak <bezjak.miro@gmail.com>
#
# Licensed under the MIT License (the "License"); you may
# not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.opensource.org/licenses/mit-license.php
#

NAPALM_VERSION=0.1
set -o errexit

# error codes
E_USAGE=10

###################
# print functions #

# print usage to stderr and exit with E_USAGE
print_usage() {
cat >&2 << EOF
napalm - not a real package manager

SYNOPSIS
    napalm install NAME VERSION
    napalm use NAME [VERSION]
    napalm show [NAME [VERSION]]
    napalm create-plugin NAME
    napalm list-plugins
    napalm -h
    napalm -v

NAME    - program name
VERSION - program version
EOF

exit $E_USAGE
}

# print version to stderr and exit
print_version() {
cat >&2 << EOF
napalm $NAPALM_VERSION
Copyright (c) 2010 Miro Bezjak <bezjak.miro@gmail.com>
License MIT: http://www.opensource.org/licenses/mit-license.php
Documentation & source code: http://github.com/mbezjak/napalm

NAPALM_HOME = $NAPALM_HOME
EOF

exit 0
}

# print functions #
###################

resolve_napalm_home() {
  if [[ -z "$NAPALM_HOME" ]]; then
    local _bin=$(dirname $(readlink -f $0))
    NAPALM_HOME=$(readlink -f ${_bin}/..)
  fi
}

init_logging() {
  mkdir -p $NAPALM_USER_HOME/logs

  LOG4SH_CONFIGURATION='none' . ${NAPALM_HOME}/lib/log4sh
  log4sh_resetConfiguration

  logger_setLevel DEBUG

  logger_addAppender fileLog
  appender_setType fileLog RollingFileAppender
  appender_file_setFile fileLog ${NAPALM_USER_HOME}/logs/napalm.log
  appender_file_setMaxFileSize fileLog 10KB
  appender_file_setMaxBackupIndex fileLog 1
  appender_setLayout fileLog PatternLayout
  appender_setPattern fileLog '%d - %p - %m'
  appender_activateOptions fileLog
}

#################
# program start #

resolve_napalm_home
. ${NAPALM_HOME}/lib/libnapalm
configure_environment
init_logging
logger_debug "called: napalm $@"

while getopts "hv" option; do
  case $option in
    v) print_version ;;
    h) print_usage ;;
    *) print_usage ;;
  esac
done
shift $((OPTIND-1))


exit 0
